; =============================================================================
; Asterisk Dialplan for Open Medical Secretary
; =============================================================================
; Routes incoming calls to the AI voice assistant via AudioSocket
; =============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; AudioSocket server address (Open Medical Secretary)
AUDIOSOCKET_HOST=host.docker.internal
AUDIOSOCKET_PORT=9001

; =============================================================================
; INCOMING CALLS FROM SIP TRUNK
; =============================================================================
[from-trunk]
; All incoming calls go to the AI assistant
exten => _X.,1,NoOp(Incoming call from ${CALLERID(num)} to ${EXTEN})
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,NoOp(Connecting to Open Medical Secretary...)
 same => n,AudioSocket(${AUDIOSOCKET_HOST}:${AUDIOSOCKET_PORT},${CHANNEL(uniqueid)})
 same => n,NoOp(Call ended)
 same => n,Hangup()

; Handle specific DID numbers (if you have multiple)
; exten => 0142XXXXXX,1,Goto(from-trunk,s,1)

; =============================================================================
; INTERNAL EXTENSIONS (for testing)
; =============================================================================
[internal]
; Test extension - dial 100 to test the AI assistant
exten => 100,1,NoOp(Test call to AI Assistant)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,AudioSocket(${AUDIOSOCKET_HOST}:${AUDIOSOCKET_PORT},${CHANNEL(uniqueid)})
 same => n,Hangup()

; Echo test - dial 999
exten => 999,1,Answer()
 same => n,Echo()
 same => n,Hangup()

; =============================================================================
; OUTBOUND CALLS (if needed)
; =============================================================================
[outbound]
; Route outbound calls through the SIP trunk
exten => _0XXXXXXXXX,1,NoOp(Outbound call to ${EXTEN})
 same => n,Set(CALLERID(num)=${TRUNK_CALLERID})
 same => n,Dial(PJSIP/${EXTEN}@trunk-endpoint,60)
 same => n,Hangup()

; International calls
exten => _00.,1,NoOp(International call to ${EXTEN})
 same => n,Set(CALLERID(num)=${TRUNK_CALLERID})
 same => n,Dial(PJSIP/${EXTEN}@trunk-endpoint,60)
 same => n,Hangup()
