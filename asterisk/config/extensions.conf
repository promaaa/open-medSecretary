; =============================================================================
; Asterisk Dialplan for Open Medical Secretary
; =============================================================================
; IVR Menu + AI Assistant + Doctor Transfer
; =============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; AudioSocket server (AI Assistant)
AUDIOSOCKET_HOST=host.docker.internal
AUDIOSOCKET_PORT=9001

; Doctor's phone number for emergencies/transfers
DOCTOR_PHONE=${DOCTOR_PHONE_NUMBER}

; Greeting audio files (will use TTS if not present)
GREETING_SOUND=custom/greeting
MENU_SOUND=custom/menu

; =============================================================================
; INCOMING CALLS - IVR MENU
; =============================================================================
[from-trunk]
exten => _X.,1,NoOp(=== Appel entrant de ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,Goto(ivr-main,s,1)

; =============================================================================
; IVR MAIN MENU
; =============================================================================
[ivr-main]
exten => s,1,NoOp(=== Menu Principal ===)
 ; Play greeting and menu
 same => n,Set(TIMEOUT(response)=10)
 same => n,Set(TIMEOUT(digit)=3)
 
 ; Try to play custom audio, fallback to Festival TTS
 same => n,TryExec(Playback(${GREETING_SOUND}))
 same => n,GotoIf($["${TRYSTATUS}" != "SUCCESS"]?tts-greeting)
 same => n,Goto(play-menu)

 ; TTS Greeting if no audio file
 same => n(tts-greeting),Festival(Bonjour et bienvenue au cabinet médical.)
 
 ; Play menu options
 same => n(play-menu),TryExec(Playback(${MENU_SOUND}))
 same => n,GotoIf($["${TRYSTATUS}" != "SUCCESS"]?tts-menu)
 same => n,Goto(wait-input)
 
 ; TTS Menu if no audio file
 same => n(tts-menu),Festival(Pour gérer vos rendez-vous, tapez 1. Pour une urgence médicale, tapez 2. Pour toute autre demande, tapez 3. Pour répéter ce message, tapez étoile.)
 
 ; Wait for input
 same => n(wait-input),WaitExten(10)
 
 ; No input - go to AI assistant
 same => n,NoOp(Pas de réponse, transfert vers assistant IA)
 same => n,Goto(ai-assistant,s,1)

; === Option 1: Gestion RDV (AI Assistant) ===
exten => 1,1,NoOp(=== Option 1: Gestion RDV ===)
 same => n,Festival(Vous allez être mis en relation avec notre assistant pour la gestion de vos rendez-vous.)
 same => n,Wait(0.5)
 same => n,Goto(ai-assistant,s,1)

; === Option 2: Urgence (Transfer to Doctor) ===
exten => 2,1,NoOp(=== Option 2: Urgence ===)
 same => n,Festival(Transfert vers le médecin. Veuillez patienter.)
 same => n,Wait(0.5)
 same => n,Goto(transfer-doctor,s,1)

; === Option 3: Assistant IA direct ===
exten => 3,1,NoOp(=== Option 3: Assistant IA ===)
 same => n,Festival(Mise en relation avec l'assistant.)
 same => n,Wait(0.5)
 same => n,Goto(ai-assistant,s,1)

; === Option *: Repeat menu ===
exten => *,1,NoOp(=== Répétition menu ===)
 same => n,Goto(ivr-main,s,1)

; === Invalid option ===
exten => i,1,NoOp(=== Option invalide ===)
 same => n,Festival(Option non reconnue.)
 same => n,Wait(0.5)
 same => n,Goto(ivr-main,s,play-menu)

; === Timeout ===
exten => t,1,NoOp(=== Timeout ===)
 same => n,Goto(ai-assistant,s,1)

; =============================================================================
; AI ASSISTANT (AudioSocket)
; =============================================================================
[ai-assistant]
exten => s,1,NoOp(=== Connexion Assistant IA ===)
 same => n,AudioSocket(${AUDIOSOCKET_HOST}:${AUDIOSOCKET_PORT},${CHANNEL(uniqueid)})
 same => n,NoOp(=== Fin conversation IA ===)
 same => n,Hangup()

; =============================================================================
; TRANSFER TO DOCTOR
; =============================================================================
[transfer-doctor]
exten => s,1,NoOp(=== Transfert vers Docteur ===)
 ; Check if doctor number is configured
 same => n,GotoIf($["${DOCTOR_PHONE}" = ""]?no-doctor)
 
 ; Call doctor's phone
 same => n,Festival(Appel du médecin en cours.)
 same => n,Dial(PJSIP/${DOCTOR_PHONE}@trunk-endpoint,60,m)
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?done)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,Goto(unavailable)
 
 ; Doctor answered
 same => n(done),NoOp(Appel terminé)
 same => n,Hangup()
 
 ; Doctor busy
 same => n(busy),Festival(Le médecin est actuellement en ligne. Souhaitez-vous laisser un message à l'assistant?)
 same => n,Wait(1)
 same => n,Goto(ai-assistant,s,1)
 
 ; Doctor unavailable
 same => n(unavailable),Festival(Le médecin n'est pas disponible. Vous allez être mis en relation avec l'assistant.)
 same => n,Wait(1)
 same => n,Goto(ai-assistant,s,1)
 
 ; No doctor number configured
 same => n(no-doctor),Festival(Le numéro du médecin n'est pas configuré. Pour une urgence vitale, appelez le 15.)
 same => n,Wait(1)
 same => n,Goto(ai-assistant,s,1)

; =============================================================================
; INTERNAL TESTING
; =============================================================================
[internal]
; Dial 100 for AI assistant directly
exten => 100,1,NoOp(Test: Assistant IA direct)
 same => n,Answer()
 same => n,Goto(ai-assistant,s,1)

; Dial 101 for IVR menu
exten => 101,1,NoOp(Test: Menu IVR)
 same => n,Answer()
 same => n,Goto(ivr-main,s,1)

; Dial 999 for echo test
exten => 999,1,Answer()
 same => n,Echo()
 same => n,Hangup()
